{% extends "base.html" %}

{% block title %}Generated Deck - MTG Deck Optimizer{% endblock %}

{% block content %}
<a href="/" class="back-link">&larr; Back to Commander Selection</a>

<h2>Generated Commander Deck</h2>

<div class="deck-stats">
    <h3>Deck Summary</h3>
    <p><strong>Commander:</strong> {{ commander.name }}</p>
    <p><strong>Color Identity:</strong> 
        {% if commander.color_identity %}
            {{ commander.color_identity | join(', ') }}
        {% else %}
            Colorless
        {% endif %}
    </p>
    <p><strong>Total Cards:</strong> {{ total_cards }} (1 Commander + {{ deck_size }} others)</p>
    <p><strong>Average CMC:</strong> {{ "%.1f"|format(deck_stats.average_cmc) }}</p>
    {% if deck_size < 99 %}
    <p style="color: #e74c3c;"><strong>Note:</strong> Your collection only has {{ deck_size }} cards that match this commander's color identity. A full Commander deck needs 99 cards plus the commander.</p>
    {% endif %}
    
    <!-- Export Section -->
    <div class="export-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
        <h4>Export Deck</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn" onclick="exportDeck('txt')" style="background-color: #27ae60;">ðŸ“„ Download .txt</button>
            <button class="btn" onclick="exportDeck('json')" style="background-color: #f39c12;">ðŸ’¾ Download .json</button>
            <button class="btn" onclick="copyMoxfield()" style="background-color: #9b59b6;">ðŸ“‹ Copy for MoxField</button>
        </div>
    </div>
</div>

<!-- Deck Statistics -->
<div class="deck-stats">
    <h3>Deck Analysis</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <h4>Card Types</h4>
            <ul style="list-style: none; padding: 0;">
                <li><strong>Creatures:</strong> {{ deck_stats.type_distribution.creatures }}</li>
                <li><strong>Instants:</strong> {{ deck_stats.type_distribution.instants }}</li>
                <li><strong>Sorceries:</strong> {{ deck_stats.type_distribution.sorceries }}</li>
                <li><strong>Enchantments:</strong> {{ deck_stats.type_distribution.enchantments }}</li>
                <li><strong>Artifacts:</strong> {{ deck_stats.type_distribution.artifacts }}</li>
                <li><strong>Lands:</strong> {{ deck_stats.type_distribution.lands }}</li>
                <li><strong>Planeswalkers:</strong> {{ deck_stats.type_distribution.planeswalkers }}</li>
            </ul>
        </div>
        <div>
            <h4>Mana Curve</h4>
            <ul style="list-style: none; padding: 0;">
                {% for cmc, count in deck_stats.cmc_distribution.items() %}
                <li><strong>{{ cmc }} CMC:</strong> {{ count }} cards</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<div class="commander-section">
    <h3>Commander</h3>
    <div class="card-item">
        <h4>{{ commander.name }}</h4>
        <p><strong>Type:</strong> {{ commander.type_line }}</p>
        <p><strong>Mana Cost:</strong> {{ commander.mana_cost or 'N/A' }}</p>
        {% if commander.power and commander.toughness %}
        <p><strong>P/T:</strong> {{ commander.power }}/{{ commander.toughness }}</p>
        {% endif %}
        {% if commander.oracle_text %}
        <p><strong>Text:</strong> {{ commander.oracle_text }}</p>
        {% endif %}
    </div>
</div>

{% if deck %}
<div class="deck-section">
    <h3>Deck ({{ deck_size }} cards)</h3>
    <div class="card-list">
        {% for card in deck %}
        <div class="card-item">
            <h4>{{ card.name or card.Name }}</h4>
            <p><strong>Type:</strong> {{ card.type_line or 'Unknown' }}</p>
            <p><strong>Mana Cost:</strong> {{ card.mana_cost or 'N/A' }}</p>
            <p><strong>CMC:</strong> {{ card.cmc or 0 }}</p>
            {% if card.power and card.toughness %}
            <p><strong>P/T:</strong> {{ card.power }}/{{ card.toughness }}</p>
            {% endif %}
            {% if card.oracle_text %}
            <p><strong>Text:</strong> {{ card.oracle_text[:150] }}{% if card.oracle_text|length > 150 %}...{% endif %}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div style="margin-top: 30px;">
    <a href="/" class="btn">Generate Another Deck</a>
</div>

<script>
// Store deck data for export
const deckData = {{ deck_data | tojson }};

function exportDeck(format) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/export-deck';
    
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    
    const dataInput = document.createElement('input');
    dataInput.type = 'hidden';
    dataInput.name = 'deck_data';
    dataInput.value = JSON.stringify(deckData);
    
    form.appendChild(formatInput);
    form.appendChild(dataInput);
    document.body.appendChild(form);
    
    if (format === 'txt' || format === 'json') {
        form.submit();
    }
    
    document.body.removeChild(form);
}

async function copyMoxfield() {
    try {
        const response = await fetch('/export-deck', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ...deckData,
                format: 'moxfield'
            })
        });
        
        const result = await response.json();
        if (result.success) {
            await navigator.clipboard.writeText(result.text);
            alert('MoxField deck list copied to clipboard!');
        } else {
            alert('Error generating MoxField format: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error copying to clipboard');
    }
}
</script>
{% endblock %}
